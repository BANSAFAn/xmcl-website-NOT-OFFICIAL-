name: üîÑ CI/CD Pipeline: Update, Security & Compatibility

on:
  schedule:
    - cron: '0 1 * * 1'
    - cron: '0 2 * * 3'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: üì¶ Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update dependencies to latest minor versions
        run: ncu -u --target minor

      - name: Install updated dependencies
        run: npm install

      - name: Run linting
        run: npm run lint

      - name: Build project to verify integrity
        run: npm run build

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'üîÑ Automated Dependency Updates'
          body: |
            ü§ñ –≠—Ç–æ—Ç PR –±—ã–ª —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

            ### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
            - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ `package.json` –±—ã–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö (–º–∏–Ω–æ—Ä–Ω—ã—Ö) –≤–µ—Ä—Å–∏–π.
            - `package-lock.json` –±—ã–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.
            - –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É `lint` –∏ —Å–±–æ—Ä–∫—É `build`.

            ### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:
            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ —Å–ª–µ–π—Ç–µ —ç—Ç–æ—Ç PR –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
          branch: automated-dependency-updates
          delete-branch: true

  security-and-compatibility:
    name: üîê Security & Compatibility Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js for NPM Audit
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies for NPM Audit
        run: npm ci

      - name: Run NPM Security Audit
        run: npm audit --audit-level=moderate

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies with Bun
        run: bun install --frozen-lockfile

      - name: Build project with Bun
        run: bun run build

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Check TypeScript code with Deno
        run: deno check --import-map=import_map.json src/main.tsx

      - name: Run Snyk Security Scan
        if: secrets.SNYK_TOKEN
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Generate Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './import_map.json';
            let denoMapStatus = '‚ùå `import_map.json` not found.';
            if (fs.existsSync(path)) {
              denoMapStatus = '‚úÖ `import_map.json` found.';
            }

            const report = `
            ## üîê Security & Compatibility Report

            ### üì¶ NPM Audit
            ‚úÖ Passed. No moderate or high vulnerabilities found.

            ### ü•ü Bun Compatibility
            ‚úÖ Passed. Dependencies installed and project built successfully with Bun.

            ### ü¶ï Deno Compatibility
            ${denoMapStatus}
            ‚úÖ TypeScript code checked for Deno compatibility.

            ### üõ°Ô∏è Snyk Scan
            ${context.payload.repository.private ? 'üîí Skipped for private repository.' : (secrets.SNYK_TOKEN ? '‚úÖ Passed. No high or critical vulnerabilities found.' : '‚ö†Ô∏è Skipped. `SNYK_TOKEN` secret not set.')}
            `;

            await core.summary
              .addRaw(report)
              .write();
